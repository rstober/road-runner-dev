 
- name: Wait for node {{ node['hostname'] }} to be UP
  ansible.builtin.shell: cmsh -c "device status {{ node['hostname'] }}"
  register: result
  until: result.stdout.find("UP") != -1
  retries: 20
  delay: 60

{% for bnode in all_nodes.physical_nodes %}
{% if bnode.hostname == node.hostname %} 
- name: Grab image from {{ bnode.hostname }} to {{ bnode.category.softwareImageProxy.parentSoftwareImage.name }}
    ansible.builtin.shell: 'cmsh -c "device use {{ bnode.hostname }}; grabimage -i {{ bnode.category.softwareImageProxy.parentSoftwareImage.name }} -w --wait"'
    args:
      executable: /bin/bash
    register: grab_image_output
    until: "'Provisioning completed' in grab_image_output.stdout"
    failed_when: "'FAILED' in grab_image_output.stdout"
    retries: 6
    delay: 10
    ignore_errors: true
{% endif %}
{% endfor %}
