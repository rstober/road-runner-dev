---

install_dir: /root/.road-runner
tmp_dir: /root/.road-runner/tmp
update_head_node: no
ansible_version: 2.10.*
clone_software_image: yes
template_node: node01
template_ip: 10.130.122.250
template_name: template
template_nic: bootif

apps:
  disabled: yes
  
networks:
  - name: ibnet
    clone_from: internalnet
    domainname: ibnet.cluster.local
    baseaddress: 10.149.0.0
    broadcastaddress: 10.149.255.255
    netmaskbits: 16
    mtu: 9000
    management: no

software_images:
  - name: default-image
    backup: default-image-orig
    clone_from: default-image
    path: /cm/images/default-image-orig
    kernel_release: 5.15.0-50-generic
    modules:
    packages:
    create_root_dirs:
  - name: dgx-os-5.4-a100-image
    backup: dgx-os-5.4-a100-image-orig
    clone_from: dgx-os-5.4-a100-image
    path: /cm/images/dgx-os-5.4-a100-image-orig
    kernel_release: 5.4.0-124-generic
    modules: 
      - name: bonding
        parameters: ''
      - name: raid0
        parameters: ''
      - name: raid1
        parameters: ''
      - name: mlx5_core
        parameters: ''
    packages: ['ifenslave']
    create_root_dirs: ['/raid']
  - name: k8s-master-image
    backup: k8s-master-image
    clone_from: default-image
    path: /cm/images/k8s-master-image
    kernel_release: 5.15.0-50-generic
    modules:
      - name: bonding
        parameters: ''
      - name: mlx5_core
        parameters: ''
    packages: ['ifenslave']
    create_root_dirs:
        
categories:
  - name: dgx
    clone_from: default
    software_image: dgx-os-5.4-a100-image
    disksetup: dgxa100-disksetup.xml
  - name: k8s
    clone_from: default
    software_image: k8s-master-image
    disksetup: k8s-one-big-partition.xml
    
nodes:
  - hostname: dgx01
    category: dgx
    clone_from: node01
    nics:
      - device: BOOTIF
        type: 1
        ip: 10.130.122.16
        network: internalnet
      - device: enp225s0f1
        type: 1
      - device: enp97s0f1
        type: 1
      - device: bond0
        type: 2
        interfaces: ['enp225s0f1','enp97s0f1']
        ip: 10.130.122.16
        network: internalnet
  # - hostname: dgx02
    # category: dgx
    # clone_from: node01
    # nics:
      # - device: BOOTIF
        # ip: 10.130.122.17
        # network: internalnet
  # - hostname: dgx03
    # category: dgx
    # clone_from: node01
    # nics:
      # - device: BOOTIF
        # ip: 10.130.122.18
        # network: internalnet
  # - hostname: dgx04
    # category: dgx
    # clone_from: node01
    # nics:
      # - device: BOOTIF
        # ip: 10.130.122.19
        # network: internalnet
  # - hostname: knode01
    # category: k8s
    # clone_from: node01
    # nics:
      # - device: BOOTIF
        # ip: 10.130.122.20
        # network: internalnet
  # - hostname: knode02
    # category: k8s
    # clone_from: node01
    # nics:
      # - device: BOOTIF
        # ip: 10.130.122.21
        # network: internalnet
  # - hostname: knode03
    # category: k8s
    # clone_from: node01
    # nics:
      # - device: BOOTIF
        # ip: 10.130.122.22
        # network: internalnet
    
csps:
  - name: amazon
    type: aws
    useMarketplaceAMIs: AS_NEEDED
    
users:
  - rstober
  - yangya
    
wlms:
  - name: slurm
    constrain_devices: yes
    queues:
      - queue_name: gpu
        clone_from: defq
        default_queue: false
        over_subscribe: yes:4
        wlm_cluster: slurm
      - queue_name: jup
        clone_from: defq
        default_queue: false
        over_subscribe: yes:4
        wlm_cluster: slurm
    configuration_overlays:
      - name: slurm-client
        categories: ['cloned']
        allHeadNodes: false
        roles:
          - name: slurmclient
            wlm_cluster: slurm
            queues: ['gpu']
            sockets_per_board: 1
            cores_per_socket: 2
            threads_per_core: 2
            slots: 4
            real_memory: 15535
            generic_resources:
              - name: gpu
                alias: gpu0
                file: /dev/nvidia0
                type: t4
                count: 1
                consumable: true
                add_to_gres_config: true
      - name: slurm-jupyter
        categories: ['jup']
        allHeadNodes: false
        roles:
          - name: slurmclient
            wlm_cluster: slurm
            queues: ['jup']
            sockets_per_board: 1
            cores_per_socket: 2
            threads_per_core: 2
            slots: 4
            real_memory: 15535
            generic_resources:
              - name: gpu
                alias: gpu0
                file: /dev/nvidia0
                type: t4
                count: 1
                consumable: true
                add_to_gres_config: true

autoscaler:
    name: auto-scaler
    categories: []
    allHeadNodes: true
    roles:
      - name: scaleserver
        runInterval: 60
        debug: true
        index: 0        
        resource_providers:
          - provider_name: aws
            type: ScaleDynamicNodesProvider
            templateNode: node02
            startTemplateNode: false
            stopTemplateNode: false
            nodeRange: node02..node04
            networkInterface: BOOTIF
            defaultResources: "['cpus=4','mem_free:slurm=16GB','gpu_free:t4:slurm=1']"
        engines:
          - name: slurm
            type: ScaleHpcEngine
            workloadsPerNode: 4
            priority: 10
            wlmCluster: slurm
            trackers:
              - name: gpu
                type: ScaleHpcQueueTracker
                queue: gpu
                assignCategory: cloned
                allowedResourceProviders: ['aws']
                workloadsPerNode: 4
 
jupyter:
    server: jupyter
    wlm_queues: ['jup']
    wlm_categories: jup
    wlm_nodes:
